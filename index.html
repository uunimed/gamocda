<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24-საათიანი მედდის ცვლები - მოქნილი საათები</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <style>
        :root {
            --shift-color: #2c5aa0;
            --shift-light: #e8efff;
            --nurse-9h: #34c759;
            --nurse-15h: #ff8a4a;
            --nurse-24h: #9d4edd;
            --weekend-color: #f8f9fa;
            --today-color: #fff9e6;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f9ff 0%, #f0f7ff 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .header-section {
            background: linear-gradient(135deg, var(--shift-color) 0%, #4a7cff 100%);
            color: white;
            padding: 2rem;
            border-radius: var(--radius);
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .main-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: none;
            transition: var(--transition);
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            background: #f8f9fa;
            border-bottom: 2px solid #eaeaea;
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            color: var(--shift-color);
            font-size: 1.2rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .shift-config {
            margin-bottom: 2rem;
        }

        .nurse-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .nurse-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #eaeaea;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .nurse-input:focus {
            border-color: var(--shift-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .add-nurse-btn {
            background: var(--shift-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .add-nurse-btn:hover {
            background: #1a3d7a;
            transform: translateY(-2px);
        }

        .nurse-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .nurse-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--shift-color);
            transition: var(--transition);
        }

        .nurse-item:hover {
            background: #e9ecef;
        }

        .nurse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .nurse-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .nurse-hours-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }

        .badge-9h { background: var(--nurse-9h); }
        .badge-15h { background: var(--nurse-15h); }
        .badge-24h { background: var(--nurse-24h); }
        .badge-custom { background: #6c757d; }

        .nurse-restrictions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #dee2e6;
        }

        .restriction-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .restriction-checkbox input {
            width: 16px;
            height: 16px;
        }

        .remove-nurse-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
        }

        .remove-nurse-btn:hover {
            background: #c82333;
        }

        .hours-options {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .hour-option {
            text-align: center;
            padding: 1rem;
            border: 2px solid #eaeaea;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .hour-option.selected {
            border-color: var(--shift-color);
            background: var(--shift-light);
        }

        .hour-option-9h { border-left: 4px solid var(--nurse-9h); }
        .hour-option-15h { border-left: 4px solid var(--nurse-15h); }
        .hour-option-24h { border-left: 4px solid var(--nurse-24h); }

        .actions-panel {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--shift-color) 0%, #4a7cff 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
        }

        .btn-primary-custom:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(44, 90, 160, 0.2);
        }

        /* Calendar Styles */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .month-year {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--shift-color);
        }

        .calendar-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .calendar-table th {
            background: var(--shift-color);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
        }

        .calendar-table td {
            border: 1px solid #eaeaea;
            padding: 0.5rem;
            height: 120px;
            vertical-align: top;
            position: relative;
        }

        .calendar-table td.weekend {
            background: var(--weekend-color);
        }

        .calendar-table td.today {
            background: var(--today-color);
            border: 2px solid #ffc107;
        }

        .day-number {
            position: absolute;
            top: 5px;
            right: 5px;
            font-weight: 600;
            color: #495057;
        }

        .shift-info {
            margin-top: 25px;
            font-size: 0.8rem;
        }

        .nurse-assignment {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-top: 5px;
        }

        .nurse-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            margin: 1px;
            white-space: nowrap;
        }

        .nurse-9h { background: var(--nurse-9h); color: white; }
        .nurse-15h { background: var(--nurse-15h); color: white; }
        .nurse-24h { background: var(--nurse-24h); color: white; }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--shift-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: var(--shadow);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.warning { background: #ffc107; color: #000; }

        .legend {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .color-9h { background: var(--nurse-9h); }
        .color-15h { background: var(--nurse-15h); }
        .color-24h { background: var(--nurse-24h); }

        .footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eaeaea;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .shift-status {
            position: absolute;
            bottom: 5px;
            left: 5px;
            font-size: 0.7rem;
            padding: 2px 5px;
            border-radius: 3px;
            background: #f8f9fa;
        }

        .status-complete { color: #28a745; }
        .status-incomplete { color: #dc3545; }

        .restriction-input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .custom-hours-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="header-section">
        <h1 class="main-title">24-საათიანი მედდის ცვლები</h1>
        <p class="subtitle">მოქნილი საათები (9/15/24 საათი) • ინდივიდუალური შეზღუდვები • მინიმუმ 2 დღე დასვენება</p>
    </div>

    <div class="app-container">
        <!-- Configuration Panel -->
        <div class="configuration-panel">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-user-nurse"></i> მედდების მართვა
                </div>
                <div class="card-body">
                    <div class="shift-config">
                        <h4>მედდების დამატება (მინიმუმ 4 მედდა)</h4>
                        <div class="nurse-input-group">
                            <input type="text" class="nurse-input" id="nurse-name-input" placeholder="მედდის სახელი">
                            <button class="add-nurse-btn" id="add-nurse-btn">დამატება</button>
                        </div>
                        
                        <h5 style="margin-top: 1rem;">სასურველი სამუშაო საათები:</h5>
                        <div class="hours-options">
                            <div class="hour-option hour-option-9h" data-hours="9">
                                <div>9 საათი</div>
                                <small>მოკლე ცვლა</small>
                            </div>
                            <div class="hour-option hour-option-15h" data-hours="15">
                                <div>15 საათი</div>
                                <small>გრძელი ცვლა</small>
                            </div>
                            <div class="hour-option hour-option-24h" data-hours="24">
                                <div>24 საათი</div>
                                <small>მთელი დღე</small>
                            </div>
                        </div>
                        
                        <div class="custom-hours-input" style="display: none;">
                            <input type="number" class="nurse-input" id="custom-hours-input" min="1" max="24" placeholder="საათები">
                            <button class="add-nurse-btn" id="set-custom-hours">დაყენება</button>
                        </div>
                        
                        <h5 style="margin-top: 1rem;">დამატებული მედდები:</h5>
                        <ul class="nurse-list" id="nurse-list"></ul>
                    </div>

                    <div class="actions-panel">
                        <button class="btn-primary-custom" id="generate-schedule">
                            <i class="fas fa-calendar-alt"></i> განრიგის გენერირება
                        </button>
                        <button class="btn-primary-custom" id="save-schedule">
                            <i class="fas fa-save"></i> შენახვა
                        </button>
                        <button class="btn-primary-custom" id="load-schedule">
                            <i class="fas fa-folder-open"></i> ჩატვირთვა
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar -->
        <div class="calendar-panel">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-calendar-day"></i> თებერვლის განრიგი
                </div>
                <div class="card-body">
                    <div class="calendar-header">
                        <div class="month-year">თებერვალი 2024</div>
                        <div class="total-hours">დღის სულ: <span id="daily-total">0</span> საათი</div>
                    </div>

                    <div class="calendar">
                        <table class="calendar-table">
                            <thead>
                                <tr>
                                    <th>კვი</th>
                                    <th>ორშ</th>
                                    <th>სამ</th>
                                    <th>ოთხ</th>
                                    <th>ხუთ</th>
                                    <th>პარ</th>
                                    <th>შაბ</th>
                                </tr>
                            </thead>
                            <tbody id="calendar-body"></tbody>
                        </table>
                    </div>

                    <!-- Statistics -->
                    <div class="stats-panel">
                        <div class="stat-card">
                            <div class="stat-value" id="total-nurses">0</div>
                            <div class="stat-label">სულ მედდა</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-shifts">0</div>
                            <div class="stat-label">დაგეგმილი ცვლა</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avg-workload">0</div>
                            <div class="stat-label">საშ. საათები</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="compliance">100%</div>
                            <div class="stat-label">შესაბამისობა</div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color color-9h"></div>
                            <span>9-საათიანი ცვლა</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color color-15h"></div>
                            <span>15-საათიანი ცვლა</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color color-24h"></div>
                            <span>24-საათიანი ცვლა</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #28a745;"></div>
                            <span>24 საათი შევსებული</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #dc3545;"></div>
                            <span>საათები არასაკმარისი</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>მედდის ცვლების განრიგი • მოქნილი საათები • თებერვალი 2024</p>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script>
        class NursingShiftScheduler {
            constructor() {
                this.nurses = [];
                this.schedule = {};
                this.selectedHours = 9;
                this.workCycle = 4; // Work every 4 days (default)
                this.minRestDays = 2; // Minimum 2 days rest
                this.hoursPerDay = 24;
                
                this.init();
            }
            
            init() {
                this.loadFromLocalStorage();
                this.initializeEventListeners();
                this.generateCalendar();
                this.updateStatistics();
                this.updateNurseList();
            }
            
            initializeEventListeners() {
                // Add nurse button
                document.getElementById('add-nurse-btn').addEventListener('click', () => this.addNurse());
                
                // Enter key in input
                document.getElementById('nurse-name-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addNurse();
                });
                
                // Hour selection
                document.querySelectorAll('.hour-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        document.querySelectorAll('.hour-option').forEach(o => o.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        this.selectedHours = parseInt(e.currentTarget.dataset.hours);
                    });
                });
                
                // Generate schedule
                document.getElementById('generate-schedule').addEventListener('click', () => this.generateSchedule());
                
                // Save/load
                document.getElementById('save-schedule').addEventListener('click', () => this.saveToLocalStorage());
                document.getElementById('load-schedule').addEventListener('click', () => this.loadFromLocalStorage());
                
                // Initialize hour selection
                document.querySelector('.hour-option-9h').classList.add('selected');
                
                // Custom hours
                document.getElementById('set-custom-hours').addEventListener('click', () => {
                    const customHours = parseInt(document.getElementById('custom-hours-input').value);
                    if (customHours && customHours >= 1 && customHours <= 24) {
                        this.selectedHours = customHours;
                        this.showNotification(`შერჩეულია ${customHours} საათი`, 'success');
                    }
                });
            }
            
            addNurse() {
                const nameInput = document.getElementById('nurse-name-input');
                const name = nameInput.value.trim();
                
                if (!name) {
                    this.showNotification('გთხოვთ შეიყვანოთ მედდის სახელი', 'error');
                    return;
                }
                
                if (this.nurses.find(n => n.name === name)) {
                    this.showNotification('მედდა ასეთი სახელით უკვე არსებობს', 'error');
                    return;
                }
                
                // Get custom hours if selected
                let hours = this.selectedHours;
                const customInput = document.getElementById('custom-hours-input');
                if (customInput.value && hours === 24) { // If 24h option shows custom input
                    hours = parseInt(customInput.value) || 9;
                }
                
                const nurse = {
                    id: Date.now(),
                    name: name,
                    preferredHours: hours,
                    assignedShifts: 0,
                    totalHours: 0,
                    lastWorkDay: 0,
                    daysWorked: 0,
                    restrictions: {
                        only24HourShifts: false, // Can only work 24-hour shifts
                        workEveryNDays: null, // Must work every N days (null = no restriction)
                        maxDaysPerMonth: null, // Maximum days per month
                        unavailableDays: [], // Specific unavailable days
                        maxHoursPerShift: null // Maximum hours per shift
                    },
                    availability: Array(29).fill(true)
                };
                
                this.nurses.push(nurse);
                nameInput.value = '';
                this.updateNurseList();
                this.updateStatistics();
                this.showNotification(`მედდა "${name}" დაემატა (${hours} სთ)`, 'success');
            }
            
            updateNurseList() {
                const list = document.getElementById('nurse-list');
                list.innerHTML = '';
                
                this.nurses.forEach((nurse, index) => {
                    const li = document.createElement('li');
                    li.className = 'nurse-item';
                    
                    // Determine badge class based on hours
                    let badgeClass = 'badge-custom';
                    if (nurse.preferredHours === 9) badgeClass = 'badge-9h';
                    else if (nurse.preferredHours === 15) badgeClass = 'badge-15h';
                    else if (nurse.preferredHours === 24) badgeClass = 'badge-24h';
                    
                    li.innerHTML = `
                        <div class="nurse-header">
                            <div>
                                <span class="nurse-name">${nurse.name}</span>
                                <span class="nurse-hours-badge ${badgeClass}">${nurse.preferredHours} სთ</span>
                            </div>
                            <button class="remove-nurse-btn" data-index="${index}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        <div class="nurse-restrictions">
                            <label class="restriction-checkbox">
                                <input type="checkbox" data-index="${index}" data-restriction="only24HourShifts" 
                                    ${nurse.restrictions.only24HourShifts ? 'checked' : ''}>
                                მხოლოდ 24-საათიანი ცვლები
                            </label>
                            
                            <div>
                                <small>სამუშაო ყოველი</small>
                                <input type="number" class="restriction-input" data-index="${index}" 
                                    data-restriction="workEveryNDays" min="2" max="7" 
                                    value="${nurse.restrictions.workEveryNDays || ''}" 
                                    placeholder="დღე">
                            </div>
                            
                            <div>
                                <small>მაქს. დღე/თვეში</small>
                                <input type="number" class="restriction-input" data-index="${index}" 
                                    data-restriction="maxDaysPerMonth" min="1" max="29" 
                                    value="${nurse.restrictions.maxDaysPerMonth || ''}" 
                                    placeholder="შეუზღუდავი">
                            </div>
                            
                            <div>
                                <small>მაქს. საათი/ცვლაში</small>
                                <input type="number" class="restriction-input" data-index="${index}" 
                                    data-restriction="maxHoursPerShift" min="1" max="24" 
                                    value="${nurse.restrictions.maxHoursPerShift || ''}" 
                                    placeholder="24">
                            </div>
                        </div>
                        
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                            <i class="fas fa-history"></i> სულ: ${nurse.totalHours} საათი, ${nurse.assignedShifts} ცვლა
                        </div>
                    `;
                    list.appendChild(li);
                    
                    // Add event listeners for restrictions
                    li.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.addEventListener('change', (e) => {
                            const nurseIndex = parseInt(e.target.dataset.index);
                            const restriction = e.target.dataset.restriction;
                            this.nurses[nurseIndex].restrictions[restriction] = e.target.checked;
                        });
                    });
                    
                    li.querySelectorAll('.restriction-input').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const nurseIndex = parseInt(e.target.dataset.index);
                            const restriction = e.target.dataset.restriction;
                            const value = e.target.value ? parseInt(e.target.value) : null;
                            this.nurses[nurseIndex].restrictions[restriction] = value;
                        });
                    });
                    
                    li.querySelector('.remove-nurse-btn').addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.dataset.index);
                        this.removeNurse(index);
                    });
                });
            }
            
            removeNurse(index) {
                const nurse = this.nurses[index];
                if (nurse) {
                    this.nurses.splice(index, 1);
                    this.updateNurseList();
                    this.updateStatistics();
                    this.showNotification(`მედდა "${nurse.name}" წაიშალა`, 'success');
                }
            }
            
            generateCalendar() {
                const calendarBody = document.getElementById('calendar-body');
                calendarBody.innerHTML = '';
                
                const startDay = 4;
                const daysInMonth = 29;
                let currentDay = 1;
                
                for (let week = 0; week < 5; week++) {
                    const row = document.createElement('tr');
                    
                    for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                        const cell = document.createElement('td');
                        
                        if ((week === 0 && dayOfWeek < startDay) || currentDay > daysInMonth) {
                            row.appendChild(cell);
                            continue;
                        }
                        
                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            cell.classList.add('weekend');
                        }
                        
                        const today = new Date();
                        if (today.getFullYear() === 2024 && today.getMonth() === 1 && today.getDate() === currentDay) {
                            cell.classList.add('today');
                        }
                        
                        cell.dataset.day = currentDay;
                        cell.innerHTML = `
                            <div class="day-number">${currentDay}</div>
                            <div class="shift-info" id="shift-${currentDay}">
                                <div class="nurse-assignment" id="assignment-${currentDay}"></div>
                                <div class="shift-status" id="status-${currentDay}"></div>
                            </div>
                        `;
                        
                        row.appendChild(cell);
                        currentDay++;
                    }
                    
                    calendarBody.appendChild(row);
                }
            }
            
            generateSchedule() {
                if (this.nurses.length < 4) {
                    this.showNotification('საკმარისი მედდა არ არის. საჭიროა მინიმუმ 4 მედდა.', 'error');
                    return;
                }
                
                this.schedule = {};
                this.resetNurseStats();
                
                // Separate 24-hour only nurses
                const twentyFourHourNurses = this.nurses.filter(n => n.restrictions.only24HourShifts);
                const flexibleNurses = this.nurses.filter(n => !n.restrictions.only24HourShifts);
                
                // First assign 24-hour shifts if needed
                let twentyFourHourAssigned = 0;
                for (let day = 1; day <= 29; day++) {
                    // Try to assign 24-hour nurses first
                    if (twentyFourHourNurses.length > 0) {
                        const available24hNurse = twentyFourHourNurses.find(nurse => 
                            this.isNurseAvailable(nurse, day, 24)
                        );
                        
                        if (available24hNurse) {
                            this.assignNurseToDay(available24hNurse, day, 24);
                            twentyFourHourAssigned++;
                            continue; // Day is fully covered
                        }
                    }
                    
                    // Use flexible scheduling for other days
                    this.scheduleDayFlexible(day);
                }
                
                // Try to balance 24-hour shifts among qualified nurses
                if (twentyFourHourAssigned > 0) {
                    this.balance24HourShifts(twentyFourHourNurses);
                }
                
                this.updateScheduleDisplay();
                this.updateStatistics();
                this.showNotification('განრიგი წარმატებით გენერირდა!', 'success');
            }
            
            scheduleDayFlexible(day) {
                const assignedNurses = [];
                let totalHours = 0;
                
                // Get available nurses for this day
                let availableNurses = this.getAvailableNurses(day);
                
                if (availableNurses.length === 0) {
                    return;
                }
                
                // Sort by priority (least worked, then preferred hours)
                availableNurses.sort((a, b) => {
                    // Priority to nurses who need to work based on workEveryNDays restriction
                    const aNeedsWork = a.restrictions.workEveryNDays && 
                                     (day - a.lastWorkDay >= a.restrictions.workEveryNDays);
                    const bNeedsWork = b.restrictions.workEveryNDays && 
                                     (day - b.lastWorkDay >= b.restrictions.workEveryNDays);
                    
                    if (aNeedsWork && !bNeedsWork) return -1;
                    if (!aNeedsWork && bNeedsWork) return 1;
                    
                    // Then by total hours
                    return a.totalHours - b.totalHours;
                });
                
                // Try different combinations to reach 24 hours
                const combinations = this.findHourCombinations(availableNurses);
                
                for (const combo of combinations) {
                    if (combo.totalHours === 24) {
                        // Assign this combination
                        combo.nurses.forEach(nurseInfo => {
                            const nurse = nurseInfo.nurse;
                            const hours = nurseInfo.hours;
                            
                            if (this.isNurseAvailable(nurse, day, hours)) {
                                this.assignNurseToDay(nurse, day, hours);
                                assignedNurses.push({ nurse, hours });
                                totalHours += hours;
                            }
                        });
                        
                        if (totalHours === 24) break;
                    }
                }
                
                // If no perfect combination found, use greedy approach
                if (totalHours < 24) {
                    for (const nurse of availableNurses) {
                        if (assignedNurses.find(a => a.nurse.id === nurse.id)) continue;
                        
                        let hours = nurse.preferredHours;
                        
                        // Apply max hours restriction
                        if (nurse.restrictions.maxHoursPerShift && hours > nurse.restrictions.maxHoursPerShift) {
                            hours = nurse.restrictions.maxHoursPerShift;
                        }
                        
                        // Adjust hours if needed
                        if (totalHours + hours > 24) {
                            hours = 24 - totalHours;
                        }
                        
                        if (hours > 0 && this.isNurseAvailable(nurse, day, hours)) {
                            this.assignNurseToDay(nurse, day, hours);
                            assignedNurses.push({ nurse, hours });
                            totalHours += hours;
                            
                            if (totalHours >= 24) break;
                        }
                    }
                }
                
                this.schedule[day] = {
                    nurses: assignedNurses,
                    totalHours: totalHours,
                    isComplete: totalHours === 24
                };
            }
            
            findHourCombinations(nurses) {
                const combinations = [];
                const preferredHours = nurses.map(n => n.preferredHours);
                
                // Try to find combinations that sum to 24
                for (let i = 0; i < nurses.length; i++) {
                    for (let j = i + 1; j < nurses.length; j++) {
                        // Try 2-nurse combinations
                        const sum2 = preferredHours[i] + preferredHours[j];
                        if (sum2 === 24) {
                            combinations.push({
                                nurses: [
                                    { nurse: nurses[i], hours: preferredHours[i] },
                                    { nurse: nurses[j], hours: preferredHours[j] }
                                ],
                                totalHours: sum2
                            });
                        }
                        
                        for (let k = j + 1; k < nurses.length; k++) {
                            // Try 3-nurse combinations
                            const sum3 = preferredHours[i] + preferredHours[j] + preferredHours[k];
                            if (sum3 === 24) {
                                combinations.push({
                                    nurses: [
                                        { nurse: nurses[i], hours: preferredHours[i] },
                                        { nurse: nurses[j], hours: preferredHours[j] },
                                        { nurse: nurses[k], hours: preferredHours[k] }
                                    ],
                                    totalHours: sum3
                                });
                            }
                            
                            for (let l = k + 1; l < nurses.length; l++) {
                                // Try 4-nurse combinations
                                const sum4 = preferredHours[i] + preferredHours[j] + preferredHours[k] + preferredHours[l];
                                if (sum4 === 24) {
                                    combinations.push({
                                        nurses: [
                                            { nurse: nurses[i], hours: preferredHours[i] },
                                            { nurse: nurses[j], hours: preferredHours[j] },
                                            { nurse: nurses[k], hours: preferredHours[k] },
                                            { nurse: nurses[l], hours: preferredHours[l] }
                                        ],
                                        totalHours: sum4
                                    });
                                }
                            }
                        }
                    }
                }
                
                return combinations;
            }
            
            isNurseAvailable(nurse, day, hours) {
                // Check minimum rest days
                if (nurse.lastWorkDay > 0 && (day - nurse.lastWorkDay < this.minRestDays)) {
                    return false;
                }
                
                // Check max days per month restriction
                if (nurse.restrictions.maxDaysPerMonth && 
                    nurse.daysWorked >= nurse.restrictions.maxDaysPerMonth) {
                    return false;
                }
                
                // Check if nurse can work these hours
                if (nurse.restrictions.only24HourShifts && hours !== 24) {
                    return false;
                }
                
                if (nurse.restrictions.maxHoursPerShift && hours > nurse.restrictions.maxHoursPerShift) {
                    return false;
                }
                
                // Check work every N days restriction
                if (nurse.restrictions.workEveryNDays && nurse.lastWorkDay > 0) {
                    const daysSinceLastWork = day - nurse.lastWorkDay;
                    if (daysSinceLastWork >= nurse.restrictions.workEveryNDays) {
                        // Nurse should work today
                        return true;
                    }
                }
                
                // Check general availability
                return nurse.availability[day - 1] !== false;
            }
            
            assignNurseToDay(nurse, day, hours) {
                if (!this.schedule[day]) {
                    this.schedule[day] = {
                        nurses: [],
                        totalHours: 0,
                        isComplete: false
                    };
                }
                
                this.schedule[day].nurses.push({ nurse, hours });
                this.schedule[day].totalHours += hours;
                this.schedule[day].isComplete = this.schedule[day].totalHours === 24;
                
                nurse.assignedShifts++;
                nurse.totalHours += hours;
                nurse.lastWorkDay = day;
                nurse.daysWorked++;
            }
            
            getAvailableNurses(day) {
                return this.nurses.filter(nurse => {
                    // Skip 24-hour only nurses for flexible scheduling
                    if (nurse.restrictions.only24HourShifts) return false;
                    
                    // Basic availability check
                    if (nurse.lastWorkDay > 0 && (day - nurse.lastWorkDay < this.minRestDays)) {
                        return false;
                    }
                    
                    if (nurse.restrictions.maxDaysPerMonth && 
                        nurse.daysWorked >= nurse.restrictions.maxDaysPerMonth) {
                        return false;
                    }
                    
                    return nurse.availability[day - 1] !== false;
                }).sort((a, b) => a.totalHours - b.totalHours);
            }
            
            balance24HourShifts(nurses) {
                // Count 24-hour shifts per nurse
                const shiftCounts = {};
                nurses.forEach(n => shiftCounts[n.id] = 0);
                
                // Count existing 24-hour shifts
                for (const day in this.schedule) {
                    this.schedule[day].nurses.forEach(assignment => {
                        if (assignment.hours === 24) {
                            shiftCounts[assignment.nurse.id] = (shiftCounts[assignment.nurse.id] || 0) + 1;
                        }
                    });
                }
                
                // Try to balance by reassigning if possible
                const total24HourDays = Object.values(this.schedule).filter(day => 
                    day.nurses.some(n => n.hours === 24)
                ).length;
                
                const targetPerNurse = Math.ceil(total24HourDays / nurses.length);
                
                // For nurses with too many 24-hour shifts, try to replace with flexible nurses
                for (const nurse of nurses) {
                    if (shiftCounts[nurse.id] > targetPerNurse) {
                        this.reassignExcess24HourShifts(nurse, targetPerNurse);
                    }
                }
            }
            
            reassignExcess24HourShifts(nurse, target) {
                // Find days where this nurse works 24 hours
                const nurse24HourDays = [];
                for (const day in this.schedule) {
                    const assignment = this.schedule[day].nurses.find(a => 
                        a.nurse.id === nurse.id && a.hours === 24
                    );
                    if (assignment) {
                        nurse24HourDays.push(parseInt(day));
                    }
                }
                
                // Try to reassign excess days
                const excessDays = nurse24HourDays.slice(target);
                for (const day of excessDays) {
                    // Try to find flexible nurses to cover this day
                    const flexibleNurses = this.getAvailableNurses(day).filter(n => 
                        !n.restrictions.only24HourShifts &&
                        n.id !== nurse.id
                    );
                    
                    // Try to find combination that covers 24 hours
                    let foundReplacement = false;
                    
                    // Try 2 nurses (15+9)
                    for (let i = 0; i < flexibleNurses.length && !foundReplacement; i++) {
                        for (let j = i + 1; j < flexibleNurses.length && !foundReplacement; j++) {
                            if (flexibleNurses[i].preferredHours + flexibleNurses[j].preferredHours === 24) {
                                // Replace 24-hour nurse with these two
                                this.replace24HourShift(day, nurse, [
                                    { nurse: flexibleNurses[i], hours: flexibleNurses[i].preferredHours },
                                    { nurse: flexibleNurses[j], hours: flexibleNurses[j].preferredHours }
                                ]);
                                foundReplacement = true;
                            }
                        }
                    }
                }
            }
            
            replace24HourShift(day, oldNurse, newAssignments) {
                // Remove old assignment
                this.schedule[day].nurses = this.schedule[day].nurses.filter(a => 
                    a.nurse.id !== oldNurse.id
                );
                this.schedule[day].totalHours -= 24;
                
                // Update nurse stats
                oldNurse.assignedShifts--;
                oldNurse.totalHours -= 24;
                oldNurse.daysWorked--;
                
                // Find last work day before this day
                let lastWorkBefore = 0;
                for (let d = day - 1; d >= 1; d--) {
                    if (this.schedule[d] && this.schedule[d].nurses.some(a => a.nurse.id === oldNurse.id)) {
                        lastWorkBefore = d;
                        break;
                    }
                }
                oldNurse.lastWorkDay = lastWorkBefore;
                
                // Add new assignments
                newAssignments.forEach(assignment => {
                    this.assignNurseToDay(assignment.nurse, day, assignment.hours);
                });
            }
            
            resetNurseStats() {
                this.nurses.forEach(nurse => {
                    nurse.assignedShifts = 0;
                    nurse.totalHours = 0;
                    nurse.lastWorkDay = 0;
                    nurse.daysWorked = 0;
                });
            }
            
            updateScheduleDisplay() {
                let dailyTotal = 0;
                
                for (let day = 1; day <= 29; day++) {
                    const assignmentDiv = document.getElementById(`assignment-${day}`);
                    const statusDiv = document.getElementById(`status-${day}`);
                    
                    if (!assignmentDiv) continue;
                    
                    assignmentDiv.innerHTML = '';
                    
                    if (this.schedule[day]) {
                        const daySchedule = this.schedule[day];
                        dailyTotal += daySchedule.totalHours;
                        
                        daySchedule.nurses.forEach(assignment => {
                            const badge = document.createElement('span');
                            badge.className = `nurse-badge nurse-${assignment.hours}h`;
                            badge.title = `${assignment.nurse.name} - ${assignment.hours} საათი`;
                            badge.textContent = `${assignment.nurse.name.charAt(0)}.${assignment.hours}h`;
                            assignmentDiv.appendChild(badge);
                        });
                        
                        if (daySchedule.isComplete) {
                            statusDiv.className = 'shift-status status-complete';
                            statusDiv.textContent = '24/24 საათი';
                        } else {
                            statusDiv.className = 'shift-status status-incomplete';
                            statusDiv.textContent = `${daySchedule.totalHours}/24 საათი`;
                        }
                    } else {
                        statusDiv.className = 'shift-status status-incomplete';
                        statusDiv.textContent = '0/24 საათი';
                    }
                }
                
                document.getElementById('daily-total').textContent = dailyTotal;
            }
            
            updateStatistics() {
                document.getElementById('total-nurses').textContent = this.nurses.length;
                
                let totalShifts = 0;
                Object.values(this.schedule).forEach(day => {
                    totalShifts += day.nurses?.length || 0;
                });
                document.getElementById('total-shifts').textContent = totalShifts;
                
                const avgHours = this.nurses.length > 0 
                    ? (this.nurses.reduce((sum, n) => sum + n.totalHours, 0) / this.nurses.length).toFixed(1)
                    : '0';
                document.getElementById('avg-workload').textContent = avgHours;
                
                let completeDays = 0;
                Object.values(this.schedule).forEach(day => {
                    if (day.isComplete) completeDays++;
                });
                const complianceRate = Object.keys(this.schedule).length > 0 
                    ? Math.round((completeDays / Object.keys(this.schedule).length) * 100) 
                    : 100;
                document.getElementById('compliance').textContent = complianceRate + '%';
            }
            
            saveToLocalStorage() {
                const data = {
                    nurses: this.nurses,
                    schedule: this.schedule,
                    lastUpdated: new Date().toISOString()
                };
                
                localStorage.setItem('nursingSchedule', JSON.stringify(data));
                this.showNotification('განრიგი შენახულია ლოკალურ მეხსიერებაში', 'success');
            }
            
            loadFromLocalStorage() {
                const saved = localStorage.getItem('nursingSchedule');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.nurses = data.nurses || [];
                        this.schedule = data.schedule || {};
                        
                        this.updateNurseList();
                        this.updateScheduleDisplay();
                        this.updateStatistics();
                        
                        this.showNotification('განრიგი ჩატვირთულია', 'success');
                    } catch (error) {
                        this.showNotification('შეცდომა ჩატვირთვისას', 'error');
                    }
                } else {
                    this.showNotification('შენახული განრიგი არ მოიძებნა', 'warning');
                }
            }
            
            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                   type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    ${message}
                `;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.3s ease reverse';
                    setTimeout(() => {
                        container.removeChild(notification);
                    }, 300);
                }, 5000);
            }
        }
        
        // Initialize the scheduler
        document.addEventListener('DOMContentLoaded', () => {
            window.scheduler = new NursingShiftScheduler();
        });
    </script>
</body>
</html>
