<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>მედდის ცვლების განრიგი - ავტომატური საათები</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <style>
        :root {
            --primary-color: #2c5aa0;
            --primary-light: #e8efff;
            --secondary-color: #4a7cff;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --shift-9h: #34c759;
            --shift-15h: #ff8a4a;
            --shift-24h: #9d4edd;
            --weekend-bg: #f8f9fa;
            --today-bg: #fff9e6;
            --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Noto Sans Georgian', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f9ff 0%, #f0f7ff 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .header-section {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
        }

        .main-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            border: none;
            transition: var(--transition);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            background: #f8f9fa;
            border-bottom: 2px solid #eaeaea;
            padding: 1.25rem 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Nurse Management Styles */
        .nurse-input-section {
            margin-bottom: 1.5rem;
        }

        .nurse-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .nurse-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #eaeaea;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .nurse-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1a3d7a 0%, #3a6cff 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(44, 90, 160, 0.2);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: #000;
        }

        .nurse-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 500px;
            overflow-y: auto;
        }

        .nurse-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
            position: relative;
        }

        .nurse-item:hover {
            background: #e9ecef;
        }

        .nurse-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .nurse-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .nurse-shift-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            background: var(--primary-color);
        }

        .nurse-restrictions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #dee2e6;
        }

        .restriction-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .restriction-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
        }

        .restriction-item input[type="number"] {
            width: 60px;
            padding: 0.25rem 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .remove-nurse-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger-color);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .remove-nurse-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .actions-panel {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .actions-panel .btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Calendar Styles */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .month-year {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .calendar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .calendar-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .calendar-table th {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            border: 1px solid #ddd;
        }

        .calendar-table td {
            border: 1px solid #eaeaea;
            padding: 0.75rem;
            height: 140px;
            vertical-align: top;
            position: relative;
            background: white;
        }

        .calendar-table td.weekend {
            background: var(--weekend-bg);
        }

        .calendar-table td.today {
            background: var(--today-bg);
            border: 2px solid var(--warning-color);
        }

        .calendar-table td.incomplete {
            background: #fff5f5;
        }

        .day-number {
            position: absolute;
            top: 5px;
            right: 5px;
            font-weight: 600;
            color: #495057;
            background: #f8f9fa;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .day-nurses {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nurse-assignment {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nurse-9h { background: rgba(52, 199, 89, 0.2); color: #1a7c3a; border-left: 3px solid var(--shift-9h); }
        .nurse-15h { background: rgba(255, 138, 74, 0.2); color: #c0541a; border-left: 3px solid var(--shift-15h); }
        .nurse-24h { background: rgba(157, 78, 221, 0.2); color: #5c2a9d; border-left: 3px solid var(--shift-24h); }

        .nurse-hours {
            font-weight: 600;
            font-size: 0.75rem;
        }

        .day-status {
            position: absolute;
            bottom: 5px;
            left: 5px;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            background: #f8f9fa;
        }

        .status-complete { color: var(--success-color); }
        .status-incomplete { color: var(--danger-color); }

        /* Statistics Panel */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 2rem;
        }

        @media (max-width: 768px) {
            .stats-panel {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* Legend */
        .legend {
            display: flex;
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding: 1.25rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            flex-wrap: wrap;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-color-9h { background: var(--shift-9h); }
        .legend-color-15h { background: var(--shift-15h); }
        .legend-color-24h { background: var(--shift-24h); }

        /* Notifications */
        .notification-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: var(--card-shadow);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success { background: var(--success-color); }
        .notification.error { background: var(--danger-color); }
        .notification.warning { background: var(--warning-color); color: #000; }
        .notification.info { background: var(--primary-color); }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eaeaea;
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* Day Summary */
        .day-summary {
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        /* Nurse Stats */
        .nurse-stats {
            display: flex;
            gap: 10px;
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }

        /* Alert Badge */
        .alert-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: var(--danger-color);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .nurse-restrictions {
                grid-template-columns: 1fr;
            }
        }

        /* Shift Pattern Info */
        .shift-pattern-info {
            background: var(--primary-light);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .shift-pattern-info ul {
            margin-bottom: 0;
            padding-left: 1.2rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-section">
        <h1 class="main-title">მედდის ცვლების განრიგი - ავტომატური საათები</h1>
        <p class="subtitle">4 მედდა დღეში • სისტემა თავად ირჩევს საათებს (9/15/24) • 4 დღე შესვენება 24სთ ცვლის შემდეგ</p>
    </div>

    <!-- Main Container -->
    <div class="app-container">
        <!-- Configuration Panel -->
        <div class="configuration-panel">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-user-nurse"></i> მედდების მართვა
                </div>
                <div class="card-body">
                    <div class="nurse-input-section">
                        <h5>ახალი მედდის დამატება</h5>
                        <div class="nurse-input-group">
                            <input type="text" class="nurse-input" id="nurse-name-input" placeholder="მედდის სახელი">
                            <button class="btn btn-primary" id="add-nurse-btn">
                                <i class="fas fa-plus"></i> დამატება
                            </button>
                        </div>
                        
                        <div class="shift-pattern-info">
                            <p><strong>სისტემა ავტომატურად ანიჭებს საათებს:</strong></p>
                            <ul>
                                <li>9 საათი - მოკლე ცვლა</li>
                                <li>15 საათი - გრძელი ცვლა</li>
                                <li>24 საათი - მთელი დღე (4 დღე შემდეგ შესვენებით)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <h5 style="margin-bottom: 1rem;">მედდების სია:</h5>
                    <ul class="nurse-list" id="nurse-list">
                        <!-- Nurses will be added here dynamically -->
                    </ul>
                    
                    <div class="actions-panel">
                        <button class="btn btn-primary" id="generate-schedule">
                            <i class="fas fa-calendar-alt"></i> განრიგის შექმნა
                        </button>
                        <button class="btn btn-success" id="save-schedule">
                            <i class="fas fa-save"></i> შენახვა
                        </button>
                        <button class="btn btn-warning" id="clear-all">
                            <i class="fas fa-trash"></i> გასუფთავება
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Instructions Card -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-info-circle"></i> ინსტრუქცია
                </div>
                <div class="card-body">
                    <ol style="padding-left: 1.2rem; margin-bottom: 0;">
                        <li>დაამატეთ მინიმუმ 12-15 მედდა</li>
                        <li>სისტემა თავად აირჩევს ცვლის საათებს</li>
                        <li>დააყენეთ შეზღუდვები თითოეული მედდისთვის</li>
                        <li>დააჭირეთ "განრიგის შექმნა"</li>
                        <li>სისტემა გექნებათ 4 მედდა ყოველ დღეს</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Calendar Panel -->
        <div class="calendar-panel">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-calendar-day"></i> თებერვლის განრიგი
                </div>
                <div class="card-body">
                    <div class="calendar-header">
                        <div class="month-year">თებერვალი 2024</div>
                        <div class="calendar-controls">
                            <span>დღის სულ: <strong id="daily-total">0</strong> საათი</span>
                            <button class="btn btn-primary" id="optimize-schedule">
                                <i class="fas fa-magic"></i> ოპტიმიზაცია
                            </button>
                        </div>
                    </div>

                    <div class="calendar">
                        <table class="calendar-table">
                            <thead>
                                <tr>
                                    <th>კვი</th>
                                    <th>ორშ</th>
                                    <th>სამ</th>
                                    <th>ოთხ</th>
                                    <th>ხუთ</th>
                                    <th>პარ</th>
                                    <th>შაბ</th>
                                </tr>
                            </thead>
                            <tbody id="calendar-body">
                                <!-- Calendar will be generated here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Statistics -->
                    <div class="stats-panel">
                        <div class="stat-card">
                            <div class="stat-value" id="total-nurses">0</div>
                            <div class="stat-label">სულ მედდა</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-shifts">0</div>
                            <div class="stat-label">დაგეგმილი ცვლა</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avg-workload">0</div>
                            <div class="stat-label">საშ. საათები/მედდა</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="compliance">0%</div>
                            <div class="stat-label">შესაბამისობა</div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color legend-color-9h"></div>
                            <span>9-საათიანი ცვლა</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color legend-color-15h"></div>
                            <span>15-საათიანი ცვლა</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color legend-color-24h"></div>
                            <span>24-საათიანი ცვლა</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--success-color);"></div>
                            <span>4/4 მედდა</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: var(--danger-color);"></div>
                            <span>არასაკმარისი მედდა</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>ავტომატური მედდის ცვლების განრიგი • თებერვალი 2024 • სისტემა ანიჭებს საათებს</p>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>

    <script>
        class AutomaticNursingShiftScheduler {
            constructor() {
                this.nurses = [];
                this.schedule = {};
                this.daysInMonth = 29; // February 2024
                this.targetNursesPerDay = 4; // Always 4 nurses per day
                this.minRestAfter24h = 4; // 4 days rest after 24-hour shift
                this.minRestOther = 2; // 2 days rest after 9/15-hour shifts
                
                // Initialize with sample data
                this.initSampleData();
                this.initializeEventListeners();
                this.generateCalendar();
                this.updateStatistics();
                this.updateNurseList();
            }
            
            initSampleData() {
                // Add sample nurses (no preferred hours - system will decide)
                const sampleNurses = [
                    { name: "ანა ჯანაშია", restrictions: { workEveryNDays: 4, maxDaysPerMonth: 15 } },
                    { name: "ნინო კვარაცხელია", restrictions: { workEveryNDays: 4, maxDaysPerMonth: 15 } },
                    { name: "მარიამ ბერიძე", restrictions: { workEveryNDays: 5, maxDaysPerMonth: 12 } },
                    { name: "თამარ მეფარიშვილი", restrictions: { workEveryNDays: 4, maxDaysPerMonth: 15 } },
                    { name: "კეთევან გორგაძე", restrictions: { workEveryNDays: 4, maxDaysPerMonth: 15 } },
                    { name: "ლია ციციშვილი", restrictions: { workEveryNDays: 5, maxDaysPerMonth: 12 } },
                    { name: "სალომე ნადირაძე", restrictions: { workEveryNDays: 6, maxDaysPerMonth: 10 } },
                    { name: "ნათია ჩხარტიშვილი", restrictions: { workEveryNDays: 4, maxDaysPerMonth: 15 } },
                    { name: "მაია ლომაძე", restrictions: { workEveryNDays: 4, maxDaysPerMonth: 15 } },
                    { name: "ნანა კაპანაძე", restrictions: { workEveryNDays: 5, maxDaysPerMonth: 12 } },
                    { name: "თეა გელაშვილი", restrictions: { workEveryNDays: 4, maxDaysPerMonth: 15 } },
                    { name: "ირინა მელაძე", restrictions: { workEveryNDays: 6, maxDaysPerMonth: 10 } }
                ];
                
                sampleNurses.forEach((sample, index) => {
                    const nurse = {
                        id: Date.now() + index,
                        name: sample.name,
                        // No preferred hours - system will assign dynamically
                        assignedShifts: 0,
                        totalHours: 0,
                        lastWorkDay: 0,
                        lastShiftType: null, // '9h', '15h', or '24h'
                        daysWorked: 0,
                        restrictions: {
                            only24HourShifts: false,
                            workEveryNDays: sample.restrictions.workEveryNDays,
                            maxDaysPerMonth: sample.restrictions.maxDaysPerMonth,
                            unavailableDays: [],
                            maxHoursPerShift: null
                        },
                        availability: Array(this.daysInMonth).fill(true),
                        canWorkExtra: Math.random() > 0.7 // 30% can work extra
                    };
                    this.nurses.push(nurse);
                });
            }
            
            initializeEventListeners() {
                // Add nurse button
                document.getElementById('add-nurse-btn').addEventListener('click', () => this.addNurse());
                
                // Enter key in input
                document.getElementById('nurse-name-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addNurse();
                });
                
                // Generate schedule
                document.getElementById('generate-schedule').addEventListener('click', () => this.generateSchedule());
                
                // Optimize schedule
                document.getElementById('optimize-schedule').addEventListener('click', () => this.optimizeSchedule());
                
                // Save to localStorage
                document.getElementById('save-schedule').addEventListener('click', () => this.saveToLocalStorage());
                
                // Clear all
                document.getElementById('clear-all').addEventListener('click', () => this.clearAll());
                
                // Load from localStorage on page load
                window.addEventListener('load', () => this.loadFromLocalStorage());
            }
            
            addNurse() {
                const nameInput = document.getElementById('nurse-name-input');
                const name = nameInput.value.trim();
                
                if (!name) {
                    this.showNotification('გთხოვთ შეიყვანოთ მედდის სახელი', 'error');
                    return;
                }
                
                if (this.nurses.find(n => n.name === name)) {
                    this.showNotification('მედდა ასეთი სახელით უკვე არსებობს', 'error');
                    return;
                }
                
                const nurse = {
                    id: Date.now(),
                    name: name,
                    // System will assign hours automatically
                    assignedShifts: 0,
                    totalHours: 0,
                    lastWorkDay: 0,
                    lastShiftType: null,
                    daysWorked: 0,
                    restrictions: {
                        only24HourShifts: false,
                        workEveryNDays: 4, // Default: can work every 4 days
                        maxDaysPerMonth: 15, // Default: max 15 days per month
                        unavailableDays: [],
                        maxHoursPerShift: null
                    },
                    availability: Array(this.daysInMonth).fill(true),
                    canWorkExtra: false
                };
                
                this.nurses.push(nurse);
                nameInput.value = '';
                this.updateNurseList();
                this.updateStatistics();
                this.showNotification(`მედდა "${name}" დაემატა (სისტემა თავად აირჩევს საათებს)`, 'success');
            }
            
            updateNurseList() {
                const list = document.getElementById('nurse-list');
                
                if (this.nurses.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-user-nurse"></i>
                            <p>მედდები არ არიან დამატებული</p>
                            <p class="text-muted">დაამატეთ მინიმუმ 12-15 მედდა განრიგის შესაქმნელად</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = '';
                
                this.nurses.forEach((nurse, index) => {
                    const li = document.createElement('li');
                    li.className = 'nurse-item';
                    
                    // Format restrictions text
                    const restrictionsText = [];
                    if (nurse.restrictions.only24HourShifts) {
                        restrictionsText.push('მხოლოდ 24სთ ცვლა');
                    }
                    if (nurse.restrictions.workEveryNDays) {
                        restrictionsText.push(`ყოველი ${nurse.restrictions.workEveryNDays} დღე`);
                    }
                    if (nurse.restrictions.maxDaysPerMonth) {
                        restrictionsText.push(`მაქს. ${nurse.restrictions.maxDaysPerMonth} დღე`);
                    }
                    
                    li.innerHTML = `
                        <button class="remove-nurse-btn" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                        
                        <div class="nurse-header">
                            <div>
                                <span class="nurse-name">${nurse.name}</span>
                                <span class="nurse-shift-badge">სისტემა აირჩევს</span>
                            </div>
                        </div>
                        
                        <div class="nurse-stats">
                            <span><i class="fas fa-calendar-check"></i> ${nurse.daysWorked} დღე</span>
                            <span><i class="fas fa-clock"></i> ${nurse.totalHours} სთ</span>
                            <span><i class="fas fa-sync-alt"></i> ${nurse.assignedShifts} ცვლა</span>
                        </div>
                        
                        ${restrictionsText.length > 0 ? `
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                            <i class="fas fa-exclamation-circle"></i> ${restrictionsText.join(' • ')}
                        </div>
                        ` : ''}
                        
                        <div class="nurse-restrictions">
                            <div class="restriction-item">
                                <input type="checkbox" id="only24h-${index}" data-index="${index}" data-restriction="only24HourShifts" 
                                    ${nurse.restrictions.only24HourShifts ? 'checked' : ''}>
                                <label for="only24h-${index}">მხოლოდ 24სთ ცვლები</label>
                            </div>
                            
                            <div class="restriction-item">
                                <label for="workEvery-${index}">ყოველი</label>
                                <input type="number" id="workEvery-${index}" data-index="${index}" 
                                    data-restriction="workEveryNDays" min="2" max="7" 
                                    value="${nurse.restrictions.workEveryNDays || ''}" placeholder="4">
                                <label for="workEvery-${index}">დღე</label>
                            </div>
                            
                            <div class="restriction-item">
                                <label for="maxDays-${index}">მაქს.</label>
                                <input type="number" id="maxDays-${index}" data-index="${index}" 
                                    data-restriction="maxDaysPerMonth" min="1" max="29" 
                                    value="${nurse.restrictions.maxDaysPerMonth || ''}" placeholder="15">
                                <label for="maxDays-${index}">დღე/თვეში</label>
                            </div>
                            
                            <div class="restriction-item">
                                <input type="checkbox" id="extraWork-${index}" data-index="${index}" data-restriction="canWorkExtra"
                                    ${nurse.canWorkExtra ? 'checked' : ''}>
                                <label for="extraWork-${index}">შეიძლება დამატებით</label>
                            </div>
                        </div>
                    `;
                    list.appendChild(li);
                    
                    // Add event listeners
                    li.querySelector('.remove-nurse-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.removeNurse(index);
                    });
                    
                    li.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.addEventListener('change', (e) => {
                            const nurseIndex = parseInt(e.target.dataset.index);
                            const restriction = e.target.dataset.restriction;
                            if (restriction === 'canWorkExtra') {
                                this.nurses[nurseIndex][restriction] = e.target.checked;
                            } else {
                                this.nurses[nurseIndex].restrictions[restriction] = e.target.checked;
                            }
                        });
                    });
                    
                    li.querySelectorAll('input[type="number"]').forEach(input => {
                        input.addEventListener('change', (e) => {
                            const nurseIndex = parseInt(e.target.dataset.index);
                            const restriction = e.target.dataset.restriction;
                            const value = e.target.value ? parseInt(e.target.value) : null;
                            this.nurses[nurseIndex].restrictions[restriction] = value;
                        });
                    });
                });
            }
            
            removeNurse(index) {
                const nurse = this.nurses[index];
                if (nurse && confirm(`ნამდვილად გსურთ მედდა "${nurse.name}"-ის წაშლა?`)) {
                    this.nurses.splice(index, 1);
                    this.updateNurseList();
                    this.updateStatistics();
                    this.showNotification(`მედდა "${nurse.name}" წაიშალა`, 'success');
                }
            }
            
            generateCalendar() {
                const calendarBody = document.getElementById('calendar-body');
                calendarBody.innerHTML = '';
                
                // February 2024 starts on Thursday (4th day of week, 0=Sunday)
                const startDay = 4;
                let currentDay = 1;
                
                // Generate 5 weeks (enough for 29 days)
                for (let week = 0; week < 5; week++) {
                    const row = document.createElement('tr');
                    
                    for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                        const cell = document.createElement('td');
                        
                        // Check if this cell should have a day number
                        if ((week === 0 && dayOfWeek < startDay) || currentDay > this.daysInMonth) {
                            // Empty cell
                            row.appendChild(cell);
                            continue;
                        }
                        
                        // Mark weekends (Sunday=0, Saturday=6)
                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            cell.classList.add('weekend');
                        }
                        
                        // Check if today
                        const today = new Date();
                        if (today.getFullYear() === 2024 && today.getMonth() === 1 && today.getDate() === currentDay) {
                            cell.classList.add('today');
                        }
                        
                        // Check if this day is incomplete
                        if (this.schedule[currentDay] && this.schedule[currentDay].nurses.length < 4) {
                            cell.classList.add('incomplete');
                            // Add alert badge for days with less than 2 nurses
                            if (this.schedule[currentDay].nurses.length < 2) {
                                const alertBadge = document.createElement('div');
                                alertBadge.className = 'alert-badge';
                                alertBadge.innerHTML = '<i class="fas fa-exclamation"></i>';
                                cell.appendChild(alertBadge);
                            }
                        }
                        
                        cell.dataset.day = currentDay;
                        cell.innerHTML = `
                            <div class="day-number">${currentDay}</div>
                            <div class="day-nurses" id="day-nurses-${currentDay}">
                                <!-- Nurses will be added here -->
                            </div>
                            <div class="day-status" id="day-status-${currentDay}">
                                <i class="fas fa-users"></i> 0/4 მედდა
                            </div>
                        `;
                        
                        row.appendChild(cell);
                        currentDay++;
                    }
                    
                    calendarBody.appendChild(row);
                }
                
                // Update the display with any existing schedule
                this.updateScheduleDisplay();
            }
            
            generateSchedule() {
                if (this.nurses.length < 12) {
                    this.showNotification('საკმარისი მედდა არ არის. საჭიროა მინიმუმ 12 მედდა.', 'error');
                    return;
                }
                
                // Reset the schedule
                this.schedule = {};
                this.resetNurseStats();
                
                // Generate schedule for each day
                for (let day = 1; day <= this.daysInMonth; day++) {
                    this.scheduleDay(day);
                }
                
                // Fix any days with insufficient nurses
                this.fixIncompleteDays();
                
                // Update display and statistics
                this.updateScheduleDisplay();
                this.updateStatistics();
                this.showNotification('განრიგი წარმატებით შეიქმნა! სისტემამ თავად აირჩია საათები.', 'success');
            }
            
            scheduleDay(day) {
                if (!this.schedule[day]) {
                    this.schedule[day] = {
                        nurses: [],
                        totalHours: 0,
                        isComplete: false
                    };
                }
                
                // Clear existing assignments for this day
                this.schedule[day].nurses = [];
                this.schedule[day].totalHours = 0;
                
                // Find available nurses for this day
                const availableNurses = this.getAvailableNurses(day);
                
                if (availableNurses.length === 0) {
                    return;
                }
                
                // Sort available nurses by priority
                availableNurses.sort((a, b) => {
                    // Priority 1: Nurses who need to work based on workEveryNDays restriction
                    const aNeedsWork = a.restrictions.workEveryNDays && 
                                     (day - a.lastWorkDay >= a.restrictions.workEveryNDays);
                    const bNeedsWork = b.restrictions.workEveryNDays && 
                                     (day - b.lastWorkDay >= b.restrictions.workEveryNDays);
                    
                    if (aNeedsWork && !bNeedsWork) return -1;
                    if (!aNeedsWork && bNeedsWork) return 1;
                    
                    // Priority 2: Nurses with fewer total hours
                    return a.totalHours - b.totalHours;
                });
                
                // We need exactly 4 nurses per day
                let assignedCount = 0;
                let targetHours = 24; // We need to cover 24 hours total
                
                // First, check if we need 24-hour nurses (for nurses with only24HourShifts restriction)
                const twentyFourHourOnlyNurses = availableNurses.filter(n => 
                    n.restrictions.only24HourShifts && 
                    this.canWork24HourShift(n, day)
                );
                
                // Assign 24-hour nurses first if available
                for (const nurse of twentyFourHourOnlyNurses) {
                    if (assignedCount >= 4) break;
                    if (this.assignNurseToDay(nurse, day, 24)) {
                        assignedCount++;
                        targetHours -= 24;
                        // Remove from available list
                        availableNurses.splice(availableNurses.indexOf(nurse), 1);
                    }
                }
                
                // Now assign remaining nurses with flexible hours
                for (const nurse of availableNurses) {
                    if (assignedCount >= 4) break;
                    
                    // Determine best shift length for this nurse on this day
                    const shiftHours = this.determineBestShiftHours(nurse, day, targetHours, assignedCount);
                    
                    if (shiftHours > 0 && this.canAssignNurse(nurse, day, shiftHours)) {
                        if (this.assignNurseToDay(nurse, day, shiftHours)) {
                            assignedCount++;
                            targetHours -= shiftHours;
                        }
                    }
                }
                
                // Update day status
                this.schedule[day].isComplete = assignedCount >= 4;
                
                // If we still don't have 4 nurses, try to find nurses who can work extra
                if (assignedCount < 4) {
                    this.findExtraNursesForDay(day, assignedCount);
                }
            }
            
            determineBestShiftHours(nurse, day, remainingHours, assignedCount) {
                // Determine the best shift hours for this nurse
                
                // If nurse has only24HourShifts restriction, return 24 if possible
                if (nurse.restrictions.only24HourShifts && this.canWork24HourShift(nurse, day)) {
                    return 24;
                }
                
                // Check nurse's last shift type
                const daysSinceLastShift = nurse.lastWorkDay > 0 ? day - nurse.lastWorkDay : Infinity;
                
                // If nurse worked 24h shift recently, they need more rest
                if (nurse.lastShiftType === '24h' && daysSinceLastShift < this.minRestAfter24h) {
                    return 0; // Can't work yet
                }
                
                // Check what shift patterns make sense based on remaining hours and assigned nurses
                const remainingNursesNeeded = 4 - assignedCount;
                
                // Ideal patterns:
                // 1. If we need 1 more nurse and remainingHours is 24, assign 24h
                // 2. If we need 2 more nurses, try 15+9 or 12+12
                // 3. If we need 3 more nurses, try 9+9+6 or 8+8+8
                // 4. If we need 4 more nurses, try 6+6+6+6
                
                if (remainingNursesNeeded === 1 && remainingHours === 24) {
                    // Last nurse needs to cover 24 hours
                    if (this.canWork24HourShift(nurse, day)) {
                        return 24;
                    }
                } else if (remainingNursesNeeded === 2) {
                    // Two nurses left, try to assign complementary hours
                    if (remainingHours === 24) {
                        // Try 15+9 pattern
                        if (this.canWorkShift(nurse, day, 15)) return 15;
                        if (this.canWorkShift(nurse, day, 9)) return 9;
                    }
                } else if (remainingNursesNeeded >= 3) {
                    // Multiple nurses left, assign smaller shifts
                    if (this.canWorkShift(nurse, day, 9)) return 9;
                    if (this.canWorkShift(nurse, day, 8)) return 8;
                    if (this.canWorkShift(nurse, day, 6)) return 6;
                }
                
                // Default to 9-hour shift if nothing else works
                if (this.canWorkShift(nurse, day, 9)) return 9;
                
                return 0;
            }
            
            canWork24HourShift(nurse, day) {
                // Check if nurse can work a 24-hour shift
                if (nurse.restrictions.maxHoursPerShift && nurse.restrictions.maxHoursPerShift < 24) {
                    return false;
                }
                
                // Check if nurse has worked recently
                if (nurse.lastWorkDay > 0) {
                    const daysSinceLastWork = day - nurse.lastWorkDay;
                    // Need at least 4 days rest after previous shift
                    const minRest = nurse.lastShiftType === '24h' ? this.minRestAfter24h : this.minRestOther;
                    if (daysSinceLastWork < minRest) {
                        return false;
                    }
                }
                
                // Check max days per month
                if (nurse.restrictions.maxDaysPerMonth && 
                    nurse.daysWorked >= nurse.restrictions.maxDaysPerMonth) {
                    return false;
                }
                
                return nurse.availability[day - 1] !== false;
            }
            
            canWorkShift(nurse, day, hours) {
                // Check if nurse can work a shift of specified hours
                if (nurse.restrictions.maxHoursPerShift && hours > nurse.restrictions.maxHoursPerShift) {
                    return false;
                }
                
                // Check if nurse has worked recently
                if (nurse.lastWorkDay > 0) {
                    const daysSinceLastWork = day - nurse.lastWorkDay;
                    // Need at least 2 days rest for non-24h shifts
                    if (daysSinceLastWork < this.minRestOther) {
                        return false;
                    }
                }
                
                // Check max days per month
                if (nurse.restrictions.maxDaysPerMonth && 
                    nurse.daysWorked >= nurse.restrictions.maxDaysPerMonth) {
                    return false;
                }
                
                return nurse.availability[day - 1] !== false;
            }
            
            getAvailableNurses(day) {
                return this.nurses.filter(nurse => {
                    // Check basic availability
                    if (!nurse.availability[day - 1]) return false;
                    
                    // Check if already assigned today
                    if (this.schedule[day] && this.schedule[day].nurses.find(n => n.id === nurse.id)) {
                        return false;
                    }
                    
                    // Check minimum rest days
                    if (nurse.lastWorkDay > 0) {
                        const daysSinceLastWork = day - nurse.lastWorkDay;
                        const minRest = nurse.lastShiftType === '24h' ? this.minRestAfter24h : this.minRestOther;
                        if (daysSinceLastWork < minRest) {
                            return false;
                        }
                    }
                    
                    // Check max days per month restriction
                    if (nurse.restrictions.maxDaysPerMonth && 
                        nurse.daysWorked >= nurse.restrictions.maxDaysPerMonth) {
                        return false;
                    }
                    
                    // Check work every N days restriction
                    if (nurse.restrictions.workEveryNDays && nurse.lastWorkDay > 0) {
                        const daysSinceLastWork = day - nurse.lastWorkDay;
                        if (daysSinceLastWork < nurse.restrictions.workEveryNDays) {
                            // Can't work yet based on restriction
                            return false;
                        }
                    }
                    
                    return true;
                });
            }
            
            canAssignNurse(nurse, day, hours) {
                // Check if nurse can be assigned to this day with these hours
                if (this.schedule[day] && this.schedule[day].nurses.find(n => n.id === nurse.id)) {
                    return false;
                }
                
                if (!nurse.availability[day - 1]) return false;
                
                if (nurse.lastWorkDay > 0) {
                    const daysSinceLastWork = day - nurse.lastWorkDay;
                    const minRest = nurse.lastShiftType === '24h' ? this.minRestAfter24h : this.minRestOther;
                    if (daysSinceLastWork < minRest) {
                        return false;
                    }
                }
                
                if (nurse.restrictions.maxDaysPerMonth && 
                    nurse.daysWorked >= nurse.restrictions.maxDaysPerMonth) {
                    return false;
                }
                
                if (hours === 24 && !this.canWork24HourShift(nurse, day)) {
                    return false;
                }
                
                if (hours < 24 && !this.canWorkShift(nurse, day, hours)) {
                    return false;
                }
                
                return true;
            }
            
            assignNurseToDay(nurse, day, hours) {
                if (!this.schedule[day]) {
                    this.schedule[day] = {
                        nurses: [],
                        totalHours: 0,
                        isComplete: false
                    };
                }
                
                // Determine shift type
                let shiftType = '9h';
                if (hours === 15) shiftType = '15h';
                if (hours === 24) shiftType = '24h';
                
                // Add nurse to day's schedule
                this.schedule[day].nurses.push({
                    id: nurse.id,
                    name: nurse.name,
                    hours: hours,
                    shiftType: shiftType
                });
                
                this.schedule[day].totalHours += hours;
                
                // Update nurse stats
                nurse.assignedShifts++;
                nurse.totalHours += hours;
                nurse.lastWorkDay = day;
                nurse.lastShiftType = shiftType;
                nurse.daysWorked++;
                
                // Mark day as complete if we have 4 nurses
                this.schedule[day].isComplete = this.schedule[day].nurses.length >= this.targetNursesPerDay;
                
                return true;
            }
            
            findExtraNursesForDay(day, currentCount) {
                // Find nurses who can work extra to fill this day
                const extraNurses = this.nurses.filter(nurse => {
                    // Only nurses who can work extra
                    if (!nurse.canWorkExtra) return false;
                    
                    // Check if they're already assigned today
                    if (this.schedule[day] && this.schedule[day].nurses.find(n => n.id === nurse.id)) {
                        return false;
                    }
                    
                    // Check if they've worked recently (allow with less rest for extra work)
                    if (nurse.lastWorkDay > 0 && (day - nurse.lastWorkDay < 1)) {
                        return false;
                    }
                    
                    // Check max days per month (allow 2 extra days)
                    if (nurse.restrictions.maxDaysPerMonth && 
                        nurse.daysWorked >= nurse.restrictions.maxDaysPerMonth - 2) {
                        return false;
                    }
                    
                    return true;
                }).sort((a, b) => a.totalHours - b.totalHours);
                
                // Assign extra nurses
                for (const nurse of extraNurses) {
                    if (currentCount >= 4) break;
                    
                    // Assign a shorter shift to extra nurses
                    const shiftHours = 6; // Short shift for extra work
                    
                    if (this.canAssignNurse(nurse, day, shiftHours)) {
                        if (this.assignNurseToDay(nurse, day, shiftHours)) {
                            currentCount++;
                        }
                    }
                }
            }
            
            fixIncompleteDays() {
                // Fix days with insufficient nurses (less than 4)
                for (let day = 1; day <= this.daysInMonth; day++) {
                    if (!this.schedule[day] || this.schedule[day].nurses.length < 4) {
                        this.fixDay(day);
                    }
                }
            }
            
            fixDay(day) {
                // Try to fix a specific day that has insufficient nurses
                const currentNurses = this.schedule[day] ? this.schedule[day].nurses.length : 0;
                const needed = 4 - currentNurses;
                
                if (needed <= 0) return;
                
                // Try to find available nurses
                const availableNurses = this.getAvailableNurses(day);
                
                // Sort by total hours (to balance workload)
                availableNurses.sort((a, b) => a.totalHours - b.totalHours);
                
                // Try to assign nurses
                for (const nurse of availableNurses) {
                    if (this.schedule[day].nurses.length >= 4) break;
                    
                    // Determine appropriate shift hours
                    let shiftHours = 6; // Default short shift for fixing
                    
                    // Check what shift would work best
                    if (this.schedule[day].totalHours < 12) {
                        // Need more hours, assign longer shift
                        shiftHours = this.canWork24HourShift(nurse, day) ? 24 : 
                                    this.canWorkShift(nurse, day, 15) ? 15 : 9;
                    } else {
                        // Just need to fill nurse count, assign shorter shift
                        shiftHours = this.canWorkShift(nurse, day, 6) ? 6 : 
                                    this.canWorkShift(nurse, day, 9) ? 9 : 0;
                    }
                    
                    if (shiftHours > 0 && this.canAssignNurse(nurse, day, shiftHours)) {
                        this.assignNurseToDay(nurse, day, shiftHours);
                    }
                }
                
                // If still not enough, try to shift nurses from other days
                if (this.schedule[day].nurses.length < 4) {
                    this.stealNursesFromOtherDays(day);
                }
            }
            
            stealNursesFromOtherDays(targetDay) {
                // Try to move nurses from nearby days to fix this day
                const daysToCheck = [
                    targetDay - 1, targetDay - 2, 
                    targetDay + 1, targetDay + 2
                ].filter(d => d >= 1 && d <= this.daysInMonth);
                
                for (const sourceDay of daysToCheck) {
                    if (!this.schedule[sourceDay] || this.schedule[sourceDay].nurses.length <= 4) {
                        continue; // Source day doesn't have extra nurses
                    }
                    
                    // Try to find a nurse from sourceDay that can work on targetDay
                    for (let i = 0; i < this.schedule[sourceDay].nurses.length; i++) {
                        const assignment = this.schedule[sourceDay].nurses[i];
                        const nurse = this.nurses.find(n => n.id === assignment.id);
                        
                        if (!nurse) continue;
                        
                        // Check if nurse can work on targetDay
                        if (this.canAssignNurse(nurse, targetDay, assignment.hours)) {
                            // Move nurse from sourceDay to targetDay
                            this.schedule[sourceDay].nurses.splice(i, 1);
                            this.schedule[sourceDay].totalHours -= assignment.hours;
                            
                            // Update nurse's lastWorkDay
                            nurse.lastWorkDay = targetDay;
                            
                            // Assign to targetDay
                            this.assignNurseToDay(nurse, targetDay, assignment.hours);
                            
                            // Check if targetDay is now fixed
                            if (this.schedule[targetDay].nurses.length >= 4) {
                                return true;
                            }
                            
                            break; // Try another source day
                        }
                    }
                }
                
                return false;
            }
            
            resetNurseStats() {
                this.nurses.forEach(nurse => {
                    nurse.assignedShifts = 0;
                    nurse.totalHours = 0;
                    nurse.lastWorkDay = 0;
                    nurse.lastShiftType = null;
                    nurse.daysWorked = 0;
                });
            }
            
            updateScheduleDisplay() {
                let dailyTotal = 0;
                let completeDays = 0;
                
                for (let day = 1; day <= this.daysInMonth; day++) {
                    const dayNursesDiv = document.getElementById(`day-nurses-${day}`);
                    const dayStatusDiv = document.getElementById(`day-status-${day}`);
                    const dayCell = document.querySelector(`td[data-day="${day}"]`);
                    
                    if (!dayNursesDiv) continue;
                    
                    // Clear existing display
                    dayNursesDiv.innerHTML = '';
                    
                    // Remove incomplete class initially
                    if (dayCell) {
                        dayCell.classList.remove('incomplete');
                        // Remove any existing alert badges
                        const existingBadge = dayCell.querySelector('.alert-badge');
                        if (existingBadge) {
                            existingBadge.remove();
                        }
                    }
                    
                    if (this.schedule[day]) {
                        const daySchedule = this.schedule[day];
                        dailyTotal += daySchedule.totalHours;
                        
                        // Display each nurse assigned to this day
                        daySchedule.nurses.forEach(assignment => {
                            const nurseDiv = document.createElement('div');
                            let nurseClass = '';
                            
                            if (assignment.hours === 9) nurseClass = 'nurse-9h';
                            else if (assignment.hours === 15) nurseClass = 'nurse-15h';
                            else if (assignment.hours === 24) nurseClass = 'nurse-24h';
                            else nurseClass = 'nurse-9h'; // Default for other hour values
                            
                            nurseDiv.className = `nurse-assignment ${nurseClass}`;
                            nurseDiv.innerHTML = `
                                <span>${assignment.name.split(' ')[0]}</span>
                                <span class="nurse-hours">${assignment.hours}სთ</span>
                            `;
                            dayNursesDiv.appendChild(nurseDiv);
                        });
                        
                        // Update status
                        const nurseCount = daySchedule.nurses.length;
                        if (dayStatusDiv) {
                            dayStatusDiv.innerHTML = `<i class="fas fa-users"></i> ${nurseCount}/4 მედდა`;
                            
                            if (nurseCount >= this.targetNursesPerDay) {
                                dayStatusDiv.className = 'day-status status-complete';
                                completeDays++;
                            } else {
                                dayStatusDiv.className = 'day-status status-incomplete';
                                // Add incomplete class to cell
                                if (dayCell) {
                                    dayCell.classList.add('incomplete');
                                    
                                    // Add alert badge for days with less than 2 nurses
                                    if (nurseCount < 2) {
                                        const alertBadge = document.createElement('div');
                                        alertBadge.className = 'alert-badge';
                                        alertBadge.innerHTML = '<i class="fas fa-exclamation"></i>';
                                        dayCell.appendChild(alertBadge);
                                    }
                                }
                            }
                        }
                    } else {
                        // No schedule for this day
                        if (dayStatusDiv) {
                            dayStatusDiv.innerHTML = `<i class="fas fa-users"></i> 0/4 მედდა`;
                            dayStatusDiv.className = 'day-status status-incomplete';
                            // Add incomplete class to cell
                            if (dayCell) {
                                dayCell.classList.add('incomplete');
                                // Add alert badge for empty days
                                const alertBadge = document.createElement('div');
                                alertBadge.className = 'alert-badge';
                                alertBadge.innerHTML = '<i class="fas fa-exclamation"></i>';
                                dayCell.appendChild(alertBadge);
                            }
                        }
                    }
                }
                
                // Update daily total display
                document.getElementById('daily-total').textContent = dailyTotal;
                
                // Return complete days count for statistics
                return completeDays;
            }
            
            updateStatistics() {
                // Update total nurses
                document.getElementById('total-nurses').textContent = this.nurses.length;
                
                // Calculate total shifts
                let totalShifts = 0;
                Object.values(this.schedule).forEach(day => {
                    totalShifts += day.nurses?.length || 0;
                });
                document.getElementById('total-shifts').textContent = totalShifts;
                
                // Calculate average workload
                const avgHours = this.nurses.length > 0 
                    ? (this.nurses.reduce((sum, n) => sum + n.totalHours, 0) / this.nurses.length).toFixed(1)
                    : '0';
                document.getElementById('avg-workload').textContent = avgHours;
                
                // Calculate compliance (days with 4 nurses)
                const completeDays = this.updateScheduleDisplay(); // This also updates display
                const complianceRate = this.daysInMonth > 0 
                    ? Math.round((completeDays / this.daysInMonth) * 100) 
                    : 0;
                document.getElementById('compliance').textContent = complianceRate + '%';
            }
            
            optimizeSchedule() {
                if (Object.keys(this.schedule).length === 0) {
                    this.showNotification('გთხოვთ ჯერ შექმნათ განრიგი', 'warning');
                    return;
                }
                
                // Try to improve the schedule
                let improvements = 0;
                
                // First, fix any days with less than 4 nurses
                improvements += this.fixAllIncompleteDays();
                
                // Then balance workload
                improvements += this.balanceWorkload();
                
                // Update display
                this.updateScheduleDisplay();
                this.updateStatistics();
                
                if (improvements > 0) {
                    this.showNotification(`განრიგი გაუმჯობესდა (${improvements} ცვლილება)`, 'success');
                } else {
                    this.showNotification('განრიგი უკვე ოპტიმალურია', 'info');
                }
            }
            
            fixAllIncompleteDays() {
                let improvements = 0;
                for (let day = 1; day <= this.daysInMonth; day++) {
                    if (!this.schedule[day] || this.schedule[day].nurses.length < 4) {
                        const before = this.schedule[day] ? this.schedule[day].nurses.length : 0;
                        this.fixDay(day);
                        const after = this.schedule[day] ? this.schedule[day].nurses.length : 0;
                        if (after > before) {
                            improvements += (after - before);
                        }
                    }
                }
                return improvements;
            }
            
            balanceWorkload() {
                let improvements = 0;
                
                // Calculate average hours per nurse
                const totalHours = this.nurses.reduce((sum, n) => sum + n.totalHours, 0);
                const avgHours = totalHours / this.nurses.length;
                
                // Find nurses with significantly different workloads
                const overworked = this.nurses.filter(n => n.totalHours > avgHours * 1.3);
                const underworked = this.nurses.filter(n => n.totalHours < avgHours * 0.7);
                
                // Try to balance
                for (const over of overworked) {
                    for (const under of underworked) {
                        // Find opportunities to shift work
                        for (let day = 1; day <= this.daysInMonth; day++) {
                            if (this.schedule[day] && 
                                this.schedule[day].nurses.find(n => n.id === over.id)) {
                                
                                // Check if under can work this day instead
                                const assignment = this.schedule[day].nurses.find(n => n.id === over.id);
                                if (assignment && this.canAssignNurse(under, day, assignment.hours)) {
                                    // Replace over with under
                                    const index = this.schedule[day].nurses.findIndex(n => n.id === over.id);
                                    this.schedule[day].nurses.splice(index, 1);
                                    this.schedule[day].nurses.push({
                                        id: under.id,
                                        name: under.name,
                                        hours: assignment.hours,
                                        shiftType: assignment.shiftType
                                    });
                                    
                                    // Update stats
                                    over.assignedShifts--;
                                    over.totalHours -= assignment.hours;
                                    over.daysWorked--;
                                    
                                    under.assignedShifts++;
                                    under.totalHours += assignment.hours;
                                    under.daysWorked++;
                                    under.lastWorkDay = Math.max(under.lastWorkDay, day);
                                    under.lastShiftType = assignment.shiftType;
                                    
                                    improvements++;
                                    break;
                                }
                            }
                        }
                    }
                }
                
                return improvements;
            }
            
            saveToLocalStorage() {
                const data = {
                    nurses: this.nurses,
                    schedule: this.schedule,
                    lastUpdated: new Date().toISOString(),
                    version: '2.0'
                };
                
                try {
                    localStorage.setItem('automaticNursingSchedule2024', JSON.stringify(data));
                    this.showNotification('განრიგი შენახულია', 'success');
                } catch (error) {
                    this.showNotification('შენახვა ვერ მოხერხდა', 'error');
                }
            }
            
            loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('automaticNursingSchedule2024');
                    if (saved) {
                        const data = JSON.parse(saved);
                        
                        if (data.nurses && data.schedule) {
                            this.nurses = data.nurses;
                            this.schedule = data.schedule;
                            
                            // Ensure arrays are properly initialized
                            this.nurses.forEach(nurse => {
                                if (!nurse.availability) {
                                    nurse.availability = Array(this.daysInMonth).fill(true);
                                }
                                if (!nurse.restrictions) {
                                    nurse.restrictions = {
                                        only24HourShifts: false,
                                        workEveryNDays: 4,
                                        maxDaysPerMonth: 15,
                                        unavailableDays: [],
                                        maxHoursPerShift: null
                                    };
                                }
                                if (!nurse.lastShiftType) {
                                    nurse.lastShiftType = null;
                                }
                            });
                            
                            this.updateNurseList();
                            this.updateScheduleDisplay();
                            this.updateStatistics();
                            
                            this.showNotification('განრიგი ჩატვირთულია', 'success');
                        }
                    }
                } catch (error) {
                    console.error('Error loading from localStorage:', error);
                }
            }
            
            clearAll() {
                if (confirm('ნამდვილად გსურთ ყველა მონაცემის გასუფთავება? ეს ქმედება შეუქცევადია.')) {
                    this.nurses = [];
                    this.schedule = {};
                    
                    // Reset input fields
                    document.getElementById('nurse-name-input').value = '';
                    
                    // Update UI
                    this.updateNurseList();
                    this.updateScheduleDisplay();
                    this.updateStatistics();
                    this.generateCalendar();
                    
                    // Clear localStorage
                    localStorage.removeItem('automaticNursingSchedule2024');
                    
                    this.showNotification('ყველა მონაცემი გასუფთავდა', 'success');
                }
            }
            
            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                // Set icon based on type
                let icon = 'info-circle';
                if (type === 'success') icon = 'check-circle';
                else if (type === 'error') icon = 'exclamation-circle';
                else if (type === 'warning') icon = 'exclamation-triangle';
                
                notification.innerHTML = `
                    <i class="fas fa-${icon}"></i>
                    <span>${message}</span>
                `;
                
                container.appendChild(notification);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 5000);
            }
        }
        
        // Initialize the scheduler when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.scheduler = new AutomaticNursingShiftScheduler();
        });
    </script>
</body>
</html>
